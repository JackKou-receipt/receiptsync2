<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReceiptSync</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 10px; }
        #output { white-space: pre-wrap; }
        .file-entry { margin: 5px 0; }
    </style>
    <!-- Free Libraries -->
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>ReceiptSync</h1>

    <div class="section">
        <h3>Step 1: Upload Receipt Files (Images or PDFs)</h3>
        <input type="file" id="receiptInput" accept="image/*,application/pdf" multiple onchange="showFileLocations()">
        <div id="fileLocations"></div>
        <button onclick="processReceipts()">Process Receipts</button>
    </div>

    <div class="section">
        <h3>Step 2: Upload Credit Card CSV</h3>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="processCSV()">Load Transactions</button>
    </div>

    <div class="section">
        <h3>Step 3: Generate Report</h3>
        <button onclick="generateCSV()">Download CSV</button>
    </div>

    <div class="section">
        <h3>Output</h3>
        <div id="output"></div>
    </div>

    <script>
        let receipts = [];
        let transactions = [];
        const GOOGLE_VISION_API_KEY = 'AIzaSyDczppCYNM_GUxAkk2NRA2SOrAyEf3witM'; // Replace with your new API key

        // Timezone mapping
        const timezones = {
            'Taiwan': 'Asia/Taipei',
            'China': 'Asia/Shanghai',
            'United States': 'America/Los_Angeles',
            'Other': 'America/Los_Angeles'
        };

        // Default currency mapping (fallback)
        const defaultCurrencies = {
            'Taiwan': 'NTD',
            'China': 'CNY',
            'United States': 'USD',
            'Other': 'USD'
        };

        // Show location dropdowns for each file
        function showFileLocations() {
            const files = document.getElementById('receiptInput').files;
            const container = document.getElementById('fileLocations');
            container.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const div = document.createElement('div');
                div.className = 'file-entry';
                div.innerHTML = `
                    <span>${file.name}</span>
                    <select id="location-${i}">
                        <option value="Taiwan">Taiwan</option>
                        <option value="China">China</option>
                        <option value="United States">United States</option>
                        <option value="Other">Other (Assume USD)</option>
                    </select>
                `;
                container.appendChild(div);
            }
        }

        // Process receipt files (images or PDFs)
        async function processReceipts() {
            const files = document.getElementById('receiptInput').files;
            if (!files.length) return alert('Please upload receipt files.');

            document.getElementById('output').innerText = 'Processing receipts...\n';
            receipts = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const location = document.getElementById(`location-${i}`).value;
                let text;
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else {
                    text = await extractTextFromImage(file);
                }
                const receipt = parseReceipt(text, location);
                receipts.push({ file, ...receipt });
                document.getElementById('output').innerText += 
                    `Raw OCR for ${file.name}: ${text}\n` +
                    `Receipt: ${receipt.date || 'Invalid date'}, ${receipt.amount} ${receipt.currency}, ${receipt.merchant}, ${location}\n`;
            }
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            return fullText;
        }

        // Extract text from image using Google Cloud Vision API
        async function extractTextFromImage(file) {
            try {
                // Convert image to base64
                const reader = new FileReader();
                const base64Image = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                // Prepare request for Google Cloud Vision API
                const requestBody = {
                    requests: [
                        {
                            image: {
                                content: base64Image
                            },
                            features: [
                                {
                                    type: "TEXT_DETECTION",
                                    maxResults: 1
                                }
                            ],
                            imageContext: {
                                languageHints: ["en", "zh-TW"] // English and Traditional Chinese
                            }
                        }
                    ]
                };

                // Send request to Google Cloud Vision API
                const response = await fetch(
                    `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    }
                );

                const data = await response.json();
                if (data.responses && data.responses[0].fullTextAnnotation) {
                    return data.responses[0].fullTextAnnotation.text;
                } else {
                    throw new Error('No text detected by Google Vision API');
                }
            } catch (error) {
                console.error('Google Vision API error:', error);
                document.getElementById('output').innerText += `Error processing ${file.name}: ${error.message}\n`;
                return '';
            }
        }

        // Parse receipt text with smart currency detection
        function parseReceipt(text, location) {
            // More flexible date patterns
            const dateMatch = text.match(
                /(\d{4}[-\/]\d{2}[-\/]\d{2}|\d{2}[-\/]\d{2}[-\/]\d{4}|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2}(?:st|nd|rd|th)?\s+\d{4})/i
            ) || ['Unknown'];

            // Look for amount with currency (e.g., NT$341.00, TWD 140, $246)
            const amountMatch = text.match(/(?:NT\$|TWD|\$)\s*([\d,]+\.?\d*)/i) || ['Unknown', '0'];
            const merchantMatch = text.match(/(?:Uber\s*Eats|UberX|THSR|Jewel\s*Changi|[A-Za-z\s]+(?:\s*Restaurant)?|[^\n]+(?=Completed))/i) || ['Unknown', 'Unknown'];

            let rawAmount = amountMatch[0] || 'Unknown';
            let amount = amountMatch[1].replace(/,/g, ''); // Remove commas from amounts like 1,330
            let currency;

            if (rawAmount.includes('NT$') || rawAmount.includes('TWD')) {
                currency = 'NTD';
            } else if (rawAmount.includes('$') && location === 'United States') {
                currency = 'USD';
            } else {
                currency = defaultCurrencies[location];
            }

            // Try to parse date with multiple formats
            let localDate = moment(dateMatch[0], ['YYYY/MM/DD', 'MM/DD/YYYY', 'MMM DD YYYY'], true);
            if (!localDate.isValid()) localDate = moment(dateMatch[0], ['DD-MMM-YYYY', 'YYYY-MMM-DD'], true);
            const pacificDate = localDate.isValid() ? localDate.clone().tz('America/Los_Angeles').format('M/DD/YY') : 'Invalid date';

            return {
                date: pacificDate,
                localDate: dateMatch[0],
                amount: amount || 'Unknown',
                currency: currency,
                merchant: merchantMatch[1]?.trim() || 'Unknown',
                location: location
            };
        }

        // Load and parse CSV file
        function processCSV() {
            const file = document.getElementById('csvInput').files[0];
            if (!file) return alert('Please upload a CSV file.');

            Papa.parse(file, {
                header: true,
                complete: (result) => {
                    transactions = result.data.map(t => ({
                        date: t['Purchase Date'] || t['Post Date'] || '', // Prefer Purchase Date
                        sourceAmount: t['Source Amount'] || '0', // Original amount
                        sourceCurrency: t['Source Currency'] || 'USD', // Original currency
                        merchant: t['Vendor Name'] || 'Unknown'
                    }));
                    document.getElementById('output').innerText += 
                        `Loaded ${transactions.length} transactions.\n`;
                }
            });
        }

        // Convert to USD using historical exchange rate (for output only)
        async function convertToUSD(amount, date, currency) {
            if (date === 'Invalid date') return amount; // Skip conversion if date is invalid
            const [day, month, year] = date.includes('/') ? date.split('/') : date.split('-');
            const formattedDate = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            if (currency === 'USD') return parseFloat(amount).toFixed(2);
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/${formattedDate}/${currency}`);
                const data = await response.json();
                const rate = data.rates['USD'];
                return (parseFloat(amount) * rate).toFixed(2);
            } catch (error) {
                console.error('Rate fetch failed:', error);
                return amount; // Fallback to original amount if API fails
            }
        }

        // Generate and download CSV
        async function generateCSV() {
            if (!receipts.length || !transactions.length) {
                return alert('Please process receipts and load transactions first.');
            }

            let csvContent = 'Date,Local Date,Amount (USD),Merchant,Original Amount,Original Currency,Location,Match Status\n';

            for (let receipt of receipts) {
                const usdAmount = await convertToUSD(receipt.amount, receipt.date, receipt.currency);
                const receiptAmount = parseFloat(receipt.amount);
                
                // Find a match with ±1 day tolerance and flexible merchant for Uber Eats
                const match = transactions.find(t => {
                    const csvDate = moment(t.date, 'M/DD/YY');
                    const receiptDate = moment(receipt.date, 'M/DD/YY');
                    if (!csvDate.isValid() || !receiptDate.isValid()) return false;
                    const dateDiff = Math.abs(csvDate.diff(receiptDate, 'days'));
                    const csvAmount = parseFloat(t.sourceAmount);
                    const csvCurrency = t.sourceCurrency;
                    const isUberRelated = t.merchant.toLowerCase().includes('uber');
                    const isUberEatsReceipt = receipt.merchant.toLowerCase().includes('uber eats') || receipt.merchant === '一款舒肥健康餐';
                    
                    return dateDiff <= 1 && csvAmount === receiptAmount && csvCurrency === receipt.currency &&
                           (t.merchant === receipt.merchant || (isUberEatsReceipt && isUberRelated));
                });

                const status = match ? 'Matched' : 'No Match';
                const row = [
                    `"${receipt.date}"`,
                    `"${receipt.localDate}"`,
                    usdAmount,
                    `"${receipt.merchant}"`,
                    `"${receipt.amount}"`,
                    `"${receipt.currency}"`,
                    `"${receipt.location}"`,
                    status
                ].join(',');
                csvContent += row + '\n';
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'expense_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
