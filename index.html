<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReceiptSync</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 10px; }
        #output { white-space: pre-wrap; }
    </style>
    <!-- Free Libraries -->
    <script src="https://unpkg.com/tesseract.js@4.0.0/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>ReceiptSync</h1>

    <div class="section">
        <h3>Step 1: Upload Receipt Files (Images or PDFs)</h3>
        <input type="file" id="receiptInput" accept="image/*,application/pdf" multiple>
        <label for="location">Expense Location:</label>
        <select id="location">
            <option value="Taiwan">Taiwan</option>
            <option value="China">China</option>
            <option value="United States">United States</option>
            <option value="Other">Other (Assume USD)</option>
        </select>
        <button onclick="processReceipts()">Process Receipts</button>
    </div>

    <div class="section">
        <h3>Step 2: Upload Credit Card CSV (California Time)</h3>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="processCSV()">Load Transactions</button>
    </div>

    <div class="section">
        <h3>Step 3: Generate Report</h3>
        <button onclick="generateCSV()">Download CSV</button>
    </div>

    <div class="section">
        <h3>Output</h3>
        <div id="output"></div>
    </div>

    <script>
        let receipts = [];
        let transactions = [];

        // Timezone mapping
        const timezones = {
            'Taiwan': 'Asia/Taipei',        // UTC+8
            'China': 'Asia/Shanghai',       // UTC+8
            'United States': 'America/Los_Angeles', // UTC-8 or -7 (PST/PDT)
            'Other': 'America/Los_Angeles'  // Default to US time
        };

        // Default currency mapping (fallback)
        const defaultCurrencies = {
            'Taiwan': 'NTD',
            'China': 'CNY',
            'United States': 'USD',
            'Other': 'USD'
        };

        // Process receipt files (images or PDFs)
        async function processReceipts() {
            const files = document.getElementById('receiptInput').files;
            const location = document.getElementById('location').value;
            if (!files.length) return alert('Please upload receipt files.');

            document.getElementById('output').innerText = 'Processing receipts...\n';
            receipts = [];

            for (let file of files) {
                let text;
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else {
                    const { data } = await Tesseract.recognize(file, 'eng');
                    text = data.text;
                }
                const receipt = parseReceipt(text, location);
                receipts.push({ file, ...receipt });
                document.getElementById('output').innerText += 
                    `Receipt: ${receipt.date}, ${receipt.amount} ${receipt.currency}, ${receipt.merchant}, ${location}\n`;
            }
        }

        // Extract text from PDF using pdf.js
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText;
        }

        // Parse receipt text with smart currency detection
        function parseReceipt(text, location) {
            const dateMatch = text.match(/(\d{2}[-\/]\d{2}[-\/]\d{4}|\d{4}[-\/]\d{2}[-\/]\d{2})/) || ['Unknown'];
            const amountMatch = text.match(/(\$|NT\$|NTD|¥|CNY)?\s*[\d.,]+/) || ['Unknown'];
            const merchantMatch = text.match(/(?:Merchant|Store|Paid to|[A-Z][a-z]+):?\s*([^\n]+)/i) || ['Unknown'];
            
            let rawAmount = amountMatch[0] || 'Unknown';
            let amount = rawAmount.replace(/[^0-9.]/g, '');
            let currency;

            // Smart currency detection
            if (rawAmount.includes('$') && !rawAmount.includes('NT$')) {
                currency = 'USD'; // $ alone means USD
            } else if (rawAmount.includes('NT$') || rawAmount.includes('NTD')) {
                currency = 'NTD';
            } else if (rawAmount.includes('¥') || rawAmount.includes('CNY')) {
                currency = 'CNY';
            } else {
                currency = defaultCurrencies[location]; // Fallback to location
            }

            // Adjust date to California time
            const localDate = moment.tz(dateMatch[1], 'MM/DD/YYYY', timezones[location]);
            const californiaDate = localDate.clone().tz('America/Los_Angeles').format('MM/DD/YYYY');

            return {
                date: californiaDate,  // Date in California time
                localDate: dateMatch[1], // Original local date
                amount: amount || 'Unknown',
                currency: currency,
                merchant: merchantMatch[1]?.trim() || 'Unknown',
                location: location
            };
        }

        // Load and parse CSV file (assumed in California time)
        function processCSV() {
            const file = document.getElementById('csvInput').files[0];
            if (!file) return alert('Please upload a CSV file.');

            Papa.parse(file, {
                header: true,
                complete: (result) => {
                    transactions = result.data.map(t => ({
                        date: t.Date || t['Transaction Date'] || t['Posting Date'],
                        amount: t.Amount?.replace('$', '') || t['Debit'],
                        merchant: t.Merchant || t.Description
                    })).filter(t => t.date && t.amount);
                    document.getElementById('output').innerText += 
                        `Loaded ${transactions.length} transactions.\n`;
                }
            });
        }

        // Convert to USD using historical exchange rate
        async function convertToUSD(amount, date, currency) {
            const [day, month, year] = date.includes('/') ? date.split('/') : date.split('-');
            const formattedDate = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            if (currency === 'USD') return parseFloat(amount).toFixed(2);
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/${formattedDate}/${currency}`);
                const data = await response.json();
                const rate = data.rates['USD'];
                return (parseFloat(amount) * rate).toFixed(2);
            } catch (error) {
                console.error('Rate fetch failed:', error);
                return amount; // Fallback
            }
        }

        // Generate and download CSV
        async function generateCSV() {
            if (!receipts.length || !transactions.length) {
                return alert('Please process receipts and load transactions first.');
            }

            // CSV header
            let csvContent = 'Date (California Time),Local Date,Amount (USD),Merchant,Original Currency,Location,Match Status\n';

            // Process each receipt
            for (let receipt of receipts) {
                const match = transactions.find(t => 
                    t.date === receipt.date && parseFloat(t.amount) === parseFloat(receipt.amount)
                );
                const usdAmount = await convertToUSD(receipt.amount, receipt.date, receipt.currency);
                const status = match ? 'Matched' : 'No Match';
                const row = [
                    `"${receipt.date}"`,
                    `"${receipt.localDate}"`,
                    usdAmount,
                    `"${receipt.merchant}"`,
                    receipt.currency,
                    receipt.location,
                    status
                ].join(',');
                csvContent += row + '\n';
            }

            // Download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'expense_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
