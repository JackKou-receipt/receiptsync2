<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReceiptSync</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 10px; }
        #output { white-space: pre-wrap; }
    </style>
    <!-- Free Libraries -->
    <script src="https://unpkg.com/tesseract.js@4.0.0/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>ReceiptSync</h1>

    <div class="section">
        <h3>Step 1: Upload Receipt Photos</h3>
        <input type="file" id="receiptInput" accept="image/*" multiple>
        <button onclick="processReceipts()">Process Receipts</button>
    </div>

    <div class="section">
        <h3>Step 2: Upload Credit Card CSV</h3>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="processCSV()">Load Transactions</button>
    </div>

    <div class="section">
        <h3>Step 3: Generate Report</h3>
        <button onclick="generateCSV()">Download CSV</button>
    </div>

    <div class="section">
        <h3>Output</h3>
        <div id="output"></div>
    </div>

    <script>
        let receipts = [];
        let transactions = [];

        // Process receipt images with Tesseract OCR
        async function processReceipts() {
            const files = document.getElementById('receiptInput').files;
            if (!files.length) return alert('Please upload receipt photos.');

            document.getElementById('output').innerText = 'Processing receipts...\n';
            receipts = [];

            for (let file of files) {
                const { data: { text } } = await Tesseract.recognize(file, 'eng');
                const receipt = parseReceipt(text);
                receipts.push({ file, ...receipt });
                document.getElementById('output').innerText += 
                    `Receipt: ${receipt.date}, ${receipt.amount} ${receipt.currency}, ${receipt.merchant}\n`;
            }
        }

        // Parse receipt text into structured data with currency detection
        function parseReceipt(text) {
            const dateMatch = text.match(/(\d{2}[-\/]\d{2}[-\/]\d{4}|\d{4}[-\/]\d{2}[-\/]\d{2})/) || ['Unknown'];
            const amountMatch = text.match(/(\$|NT\$|NTD)?\s*[\d.,]+/) || ['Unknown'];
            const merchantMatch = text.match(/(?:Merchant|Store|Paid to|[A-Z][a-z]+):?\s*([^\n]+)/i) || ['Unknown'];
            
            let rawAmount = amountMatch[0] || 'Unknown';
            let currency = 'NTD'; // Default to NTD if unclear
            let amount = rawAmount.replace(/[^0-9.]/g, '');
            
            if (rawAmount.includes('$') && !rawAmount.includes('NT$')) {
                currency = 'USD';
            } else if (rawAmount.includes('NT$') || rawAmount.includes('NTD')) {
                currency = 'NTD';
            }

            return {
                date: dateMatch[1],
                amount: amount || 'Unknown',
                currency: currency,
                merchant: merchantMatch[1]?.trim() || 'Unknown'
            };
        }

        // Load and parse CSV file
        function processCSV() {
            const file = document.getElementById('csvInput').files[0];
            if (!file) return alert('Please upload a CSV file.');

            Papa.parse(file, {
                header: true,
                complete: (result) => {
                    transactions = result.data.map(t => ({
                        date: t.Date || t['Transaction Date'] || t['Posting Date'],
                        amount: t.Amount?.replace('$', '') || t['Debit'],
                        merchant: t.Merchant || t.Description
                    })).filter(t => t.date && t.amount);
                    document.getElementById('output').innerText += 
                        `Loaded ${transactions.length} transactions.\n`;
                }
            });
        }

        // Convert NTD to USD using historical exchange rate
        async function convertToUSD(amount, date) {
            const [day, month, year] = date.includes('/') ? date.split('/') : date.split('-');
            const formattedDate = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/${formattedDate}/NTD`);
                const data = await response.json();
                const rate = data.rates['USD'];
                return (parseFloat(amount) * rate).toFixed(2);
            } catch (error) {
                console.error('Rate fetch failed:', error);
                return amount; // Fallback
            }
        }

        // Generate and download CSV
        async function generateCSV() {
            if (!receipts.length || !transactions.length) {
                return alert('Please process receipts and load transactions first.');
            }

            // CSV header
            let csvContent = 'Date,Amount (USD),Merchant,Original Currency,Match Status\n';

            // Process each receipt
            for (let receipt of receipts) {
                const match = transactions.find(t => 
                    t.date === receipt.date && parseFloat(t.amount) === parseFloat(receipt.amount)
                );
                let usdAmount = receipt.amount;
                if (receipt.currency === 'NTD') {
                    usdAmount = await convertToUSD(receipt.amount, receipt.date);
                }
                const status = match ? 'Matched' : 'No Match';
                const row = [
                    `"${receipt.date}"`,           // Wrap in quotes to handle commas
                    usdAmount,
                    `"${receipt.merchant}"`,      // Wrap in quotes
                    receipt.currency,
                    status
                ].join(',');
                csvContent += row + '\n';
            }

            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'expense_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
