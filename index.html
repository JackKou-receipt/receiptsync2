<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReceiptSync</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 10px; }
        #output { white-space: pre-wrap; }
        .file-entry { margin: 5px 0; }
    </style>
    <!-- Free Libraries -->
    <script src="https://unpkg.com/tesseract.js@4.0.0/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <h1>ReceiptSync</h1>

    <div class="section">
        <h3>Step 1: Upload Receipt Files (Images or PDFs)</h3>
        <input type="file" id="receiptInput" accept="image/*,application/pdf" multiple onchange="showFileLocations()">
        <div id="fileLocations"></div>
        <button onclick="processReceipts()">Process Receipts</button>
    </div>

    <div class="section">
        <h3>Step 2: Upload Credit Card CSV</h3>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="processCSV()">Load Transactions</button>
    </div>

    <div class="section">
        <h3>Step 3: Generate Report</h3>
        <button onclick="generateCSV()">Download CSV</button>
    </div>

    <div class="section">
        <h3>Output</h3>
        <div id="output"></div>
    </div>

    <script>
        let receipts = [];
        let transactions = [];

        // Timezone mapping
        const timezones = {
            'Taiwan': 'Asia/Taipei',
            'China': 'Asia/Shanghai',
            'United States': 'America/Los_Angeles',
            'Other': 'America/Los_Angeles'
        };

        // Default currency mapping (fallback)
        const defaultCurrencies = {
            'Taiwan': 'NTD',
            'China': 'CNY',
            'United States': 'USD',
            'Other': 'USD'
        };

        // Show location dropdowns for each file
        function showFileLocations() {
            const files = document.getElementById('receiptInput').files;
            const container = document.getElementById('fileLocations');
            container.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const div = document.createElement('div');
                div.className = 'file-entry';
                div.innerHTML = `
                    <span>${file.name}</span>
                    <select id="location-${i}">
                        <option value="Taiwan">Taiwan</option>
                        <option value="China">China</option>
                        <option value="United States">United States</option>
                        <option value="Other">Other (Assume USD)</option>
                    </select>
                `;
                container.appendChild(div);
            }
        }

        // Process receipt files (images or PDFs)
        async function processReceipts() {
            const files = document.getElementById('receiptInput').files;
            if (!files.length) return alert('Please upload receipt files.');

            document.getElementById('output').innerText = 'Processing receipts...\n';
            receipts = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const location = document.getElementById(`location-${i}`).value;
                let text;
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else {
                    const { data } = await Tesseract.recognize(file, 'eng');
                    text = data.text;
                }
                const receipt = parseReceipt(text, location);
                receipts.push({ file, ...receipt });
                document.getElementById('output').innerText += 
                    `Receipt: ${receipt.date}, ${receipt.amount} ${receipt.currency}, ${receipt.merchant}, ${location}\n`;
            }
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            return fullText;
        }

        // Parse receipt text with smart currency detection
        function parseReceipt(text, location) {
            const dateMatch = text.match(/(\d{2}[-\/]\d{2}[-\/]\d{4}|\d{4}[-\/]\d{2}[-\/]\d{2})/) || ['Unknown'];
            const amountMatch = text.match(/(\$|NT\$|NTD|¥|CNY)?\s*[\d.,]+/) || ['Unknown'];
            const merchantMatch = text.match(/(?:Merchant|Store|Paid to|[A-Z][a-z]+):?\s*([^\n]+)/i) || ['Unknown'];
            
            let rawAmount = amountMatch[0] || 'Unknown';
            let amount = rawAmount.replace(/[^0-9.]/g, '');
            let currency;

            if (rawAmount.includes('$') && !rawAmount.includes('NT$')) {
                currency = 'USD';
            } else if (rawAmount.includes('NT$') || rawAmount.includes('NTD')) {
                currency = 'NTD';
            } else if (rawAmount.includes('¥') || rawAmount.includes('CNY')) {
                currency = 'CNY';
            } else {
                currency = defaultCurrencies[location];
            }

            const localDate = moment.tz(dateMatch[1], 'MM/DD/YYYY', timezones[location]);
            const pacificDate = localDate.clone().tz('America/Los_Angeles').format('M/DD/YY'); // Match CSV format

            return {
                date: pacificDate,
                localDate: dateMatch[1],
                amount: amount || 'Unknown',
                currency: currency,
                merchant: merchantMatch[1]?.trim() || 'Unknown',
                location: location
            };
        }

        // Load and parse CSV file
        function processCSV() {
            const file = document.getElementById('csvInput').files[0];
            if (!file) return alert('Please upload a CSV file.');

            Papa.parse(file, {
                header: true,
                complete: (result) => {
                    transactions = result.data.map(t => ({
                        date: t['Purchase Date'] || t['Post Date'] || '', // Prefer Purchase Date
                        amount: t['Item Total']?.replace('$', '') || '0',
                        merchant: t['Vendor Name'] || 'Unknown'
                    }));
                    document.getElementById('output').innerText += 
                        `Loaded ${transactions.length} transactions.\n`;
                }
            });
        }

        // Convert to USD using historical exchange rate
        async function convertToUSD(amount, date, currency) {
            const [day, month, year] = date.includes('/') ? date.split('/') : date.split('-');
            const formattedDate = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            if (currency === 'USD') return parseFloat(amount).toFixed(2);
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/${formattedDate}/${currency}`);
                const data = await response.json();
                const rate = data.rates['USD'];
                return (parseFloat(amount) * rate).toFixed(2);
            } catch (error) {
                console.error('Rate fetch failed:', error);
                return amount; // Fallback to original amount if API fails
            }
        }

        // Generate and download CSV
        async function generateCSV() {
            if (!receipts.length || !transactions.length) {
                return alert('Please process receipts and load transactions first.');
            }

            let csvContent = 'Date,Local Date,Amount (USD),Merchant,Original Currency,Location,Match Status\n';

            for (let receipt of receipts) {
                const usdAmount = await convertToUSD(receipt.amount, receipt.date, receipt.currency);
                const receiptAmount = parseFloat(usdAmount);
                
                // Find a match with ±1 day and ±0.5 USD tolerance
                const match = transactions.find(t => {
                    const csvDate = moment(t.date, 'M/DD/YY');
                    const receiptDate = moment(receipt.date, 'M/DD/YY');
                    const dateDiff = Math.abs(csvDate.diff(receiptDate, 'days'));
                    const csvAmount = parseFloat(t.amount);
                    const amountDiff = Math.abs(csvAmount - receiptAmount);
                    return dateDiff <= 1 && amountDiff <= 0.5;
                });

                const status = match ? 'Matched' : 'No Match';
                const row = [
                    `"${receipt.date}"`,
                    `"${receipt.localDate}"`,
                    usdAmount,
                    `"${receipt.merchant}"`,
                    receipt.currency,
                    receipt.location,
                    status
                ].join(',');
                csvContent += row + '\n';
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'expense_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
