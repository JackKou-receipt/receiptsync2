<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReceiptSync</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 10px; }
        #output { white-space: pre-wrap; }
        .file-entry { margin: 5px 0; }
        table {
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
        .no-receipt { background-color: #ffcccc; }
    </style>
    <!-- Free Libraries -->
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <h1>ReceiptSync</h1>

    <div class="section">
        <h3>Step 1: Upload Receipt Files (Images or PDFs)</h3>
        <input type="file" id="receiptInput" accept="image/*,application/pdf" multiple onchange="showFileLocations()">
        <div id="fileLocations"></div>
        <button onclick="processReceipts()">Process Receipts</button>
    </div>

    <div class="section">
        <h3>Step 2: Upload Credit Card CSV</h3>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="processCSV()">Load Transactions</button>
    </div>

    <div class="section">
        <h3>Step 3: Generate Report</h3>
        <button onclick="generateZip()">Download ZIP (CSV + Receipts)</button>
    </div>

    <div class="section">
        <h3>Output</h3>
        <div id="output"></div>
    </div>

    <script>
        let receipts = [];
        let transactions = [];
        const GOOGLE_VISION_API_KEY = 'AIzaSyDczppCYNM_GUxAkk2NRA2SOrAyEf3witM'; // Replace with your new API key

        // Timezone mapping
        const timezones = {
            'Taiwan': 'Asia/Taipei',
            'China': 'Asia/Shanghai',
            'United States': 'America/Los_Angeles',
            'Other': 'America/Los_Angeles'
        };

        // Default currency mapping (fallback)
        const defaultCurrencies = {
            'Taiwan': 'NTD',
            'China': 'CNY',
            'United States': 'USD',
            'Other': 'USD'
        };

        // Show location dropdowns for each file
        function showFileLocations() {
            const files = document.getElementById('receiptInput').files;
            const container = document.getElementById('fileLocations');
            container.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const div = document.createElement('div');
                div.className = 'file-entry';
                div.innerHTML = `
                    <span>${file.name}</span>
                    <select id="location-${i}">
                        <option value="Taiwan">Taiwan</option>
                        <option value="China">China</option>
                        <option value="United States">United States</option>
                        <option value="Other">Other (Assume USD)</option>
                    </select>
                `;
                container.appendChild(div);
            }
        }

        // Process receipt files (images or PDFs)
        async function processReceipts() {
            const files = document.getElementById('receiptInput').files;
            if (!files.length) {
                document.getElementById('output').innerText = 'No receipt files uploaded.\n';
                receipts = [];
                displayTable();
                return;
            }

            document.getElementById('output').innerText = 'Processing receipts...\n';
            receipts = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const location = document.getElementById(`location-${i}`).value;
                let text;
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else {
                    text = await extractTextFromImage(file);
                }
                const receipt = await parseReceipt(text, location, file);
                receipts.push(receipt);
                document.getElementById('output').innerText += 
                    `Raw OCR for ${file.name}: ${text}\n` +
                    `Parsed: ${receipt.date || 'No date'}, ${receipt.amount} ${receipt.currency}, ${receipt.merchant}, ${location}\n`;
            }
            displayTable();
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            return fullText;
        }

        // Extract text from image using Google Cloud Vision API
        async function extractTextFromImage(file) {
            try {
                const reader = new FileReader();
                const base64Image = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const requestBody = {
                    requests: [
                        {
                            image: { content: base64Image },
                            features: [{ type: "TEXT_DETECTION", maxResults: 1 }],
                            imageContext: { languageHints: ["en", "zh-TW"] }
                        }
                    ]
                };

                const response = await fetch(
                    `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    }
                );

                const data = await response.json();
                if (data.responses && data.responses[0].fullTextAnnotation) {
                    return data.responses[0].fullTextAnnotation.text;
                } else {
                    throw new Error('No text detected by Google Vision API');
                }
            } catch (error) {
                console.error('Google Vision API error:', error);
                document.getElementById('output').innerText += `Error processing file: ${error.message}\n`;
                return '';
            }
        }

        // Parse receipt text with smart currency and merchant detection
        async function parseReceipt(text, location, file) {
            // Enhanced date patterns
            const dateMatch = text.match(
                /(\d{4}[-\/]\d{2}[-\/]\d{2}|\d{2}[-\/]\d{2}[-\/]\d{4}|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2}(?:st|nd|rd|th)?\s+\d{4}|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4})/i
            ) || ['No date'];

            // Enhanced amount and currency detection
            const amountMatch = text.match(/(?:NT\$|TWD|\$)\s*([\d,]+\.?\d*)/i) || ['Unknown', '0'];
            let rawAmount = amountMatch[0] || 'Unknown';
            let amount = amountMatch[1].replace(/,/g, ''); // Remove commas

            let currency = 'Unknown';
            if (rawAmount.includes('NT$') || rawAmount.includes('TWD')) {
                currency = 'TWD';
            } else if (rawAmount.includes('$')) {
                currency = 'USD'; // Prioritize $ as USD
            } else {
                currency = defaultCurrencies[location];
            }

            // Enhanced merchant detection
            const merchantMatch = text.match(
                /(Uber\s*Eats|UberX|UBER|THSR|Taiwan High Speed Rail|Jewel\s*Changi|TWGLOBAL|(?:[A-Za-z\s]+(?:\s*Restaurant)?)|(?:[^\n]+(?=Completed))|(?:一款舒肥健康餐|維克早午餐\s*餐點店))/i
            ) || ['Unknown'];
            const merchant = merchantMatch[1]?.trim() || 'Unknown';

            // Parse and convert date
            let localDate = moment(dateMatch[0], [
                'YYYY/MM/DD', 'MM/DD/YYYY', 'MMM DD YYYY', 'DD-MMM-YYYY', 'YYYY-MMM-DD'
            ], true);
            const pacificDate = localDate.isValid() 
                ? localDate.clone().tz('America/Los_Angeles').format('M/DD/YY')
                : 'No date';

            // Convert file to base64 for attachment
            const base64Image = file ? await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            }) : null;

            return {
                date: pacificDate,
                localDate: dateMatch[0],
                amount: amount || 'Unknown',
                currency: currency,
                merchant: merchant,
                location: location,
                imageData: base64Image,
                matched: false
            };
        }

        // Load and parse CSV file
        function processCSV() {
            const file = document.getElementById('csvInput').files[0];
            if (!file) return alert('Please upload a CSV file.');

            Papa.parse(file, {
                header: true,
                complete: (result) => {
                    transactions = result.data.map(t => ({
                        date: t['Purchase Date'] || t['Post Date'] || '',
                        sourceAmount: t['Source Amount'] || '0',
                        sourceCurrency: t['Source Currency'] || 'USD',
                        merchant: t['Vendor Name'] || 'Unknown',
                        matched: false
                    }));
                    document.getElementById('output').innerText += 
                        `Loaded ${transactions.length} transactions.\n`;
                    displayTable();
                }
            });
        }

        // Convert to USD using historical exchange rate
        async function convertToUSD(amount, date, currency) {
            if (date === 'No date' || date === 'Invalid date' || amount === 'Unknown' || !parseFloat(amount)) return amount;
            const [month, day, year] = date.split('/');
            const formattedDate = `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            if (currency === 'USD') return parseFloat(amount).toFixed(2);
            
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${currency}`);
                const data = await response.json();
                const rate = data.rates['USD'];
                return (parseFloat(amount) * rate).toFixed(2); // Corrected to multiply by rate
            } catch (error) {
                console.error('Rate fetch failed:', error);
                // Fallback to a static rate for TWD to USD (approx 0.0302 as of Jan 2025)
                if (currency === 'TWD') {
                    return (parseFloat(amount) * 0.0302).toFixed(2);
                }
                return amount;
            }
        }

        // Display table in output
        async function displayTable() {
            const output = document.getElementById('output');
            let html = '<table><tr><th>Date</th><th>Local Date</th><th>Amount (USD)</th><th>Merchant</th><th>Original Amount</th><th>Original Currency</th><th>Location</th><th>Match Status</th><th>Receipt</th><th>No Receipt</th></tr>';

            // Reset matched flags
            receipts.forEach(r => r.matched = false);
            transactions.forEach(t => t.matched = false);

            for (let t of transactions) {
                let usdAmount = await convertToUSD(t.sourceAmount, t.date, t.sourceCurrency);
                const receiptMatch = receipts.find(r => {
                    if (t.matched || r.matched) return false;
                    const amountDiff = Math.abs(parseFloat(r.amount) - parseFloat(t.sourceAmount));
                    let currencyMatch = r.currency === t.sourceCurrency;
                    // Special case for Jewel Changi: trust receipt currency (USD) over CSV (TWD)
                    if (r.merchant.toLowerCase().includes('jewel changi') && t.sourceAmount === '246') {
                        t.sourceCurrency = 'USD';
                        currencyMatch = true;
                    }
                    const dateMatch = r.date === 'No date' || 
                        (moment(r.date, 'M/DD/YY').isValid() && 
                         moment(t.date, 'M/DD/YY').isValid() && 
                         Math.abs(moment(t.date, 'M/DD/YY').diff(moment(r.date, 'M/DD/YY'), 'days')) <= 3);
                    const merchantMatch = (t.merchant.toLowerCase().includes('uber') && 
                        (r.merchant.toLowerCase().includes('uber') || r.merchant === '一款舒肥健康餐' || r.merchant === '維克早午餐 餐點店')) ||
                        (t.merchant.toLowerCase().includes('taiwan high speed rail') && r.merchant.toLowerCase().includes('thsr')) ||
                        (t.merchant.toLowerCase().includes('twglobal') && r.merchant.toLowerCase().includes('jewel changi'));
                    return amountDiff <= 5 && (currencyMatch || merchantMatch) && (dateMatch || merchantMatch);
                });

                const status = receiptMatch ? 'Matched' : 'No Match';
                const location = receiptMatch ? receiptMatch.location : 'Taiwan';
                if (receiptMatch) {
                    t.matched = true;
                    receiptMatch.matched = true;
                    // Override currency and amount with receipt data if matched
                    t.sourceCurrency = receiptMatch.currency;
                    usdAmount = await convertToUSD(receiptMatch.amount, t.date, receiptMatch.currency);
                }

                html += `<tr>
                    <td>${t.date}</td>
                    <td>${t.date}</td>
                    <td>${usdAmount}</td>
                    <td>${t.merchant}</td>
                    <td>${t.sourceAmount}</td>
                    <td>${t.sourceCurrency}</td>
                    <td>${location}</td>
                    <td>${status}</td>
                    <td>${receiptMatch && receiptMatch.imageData ? `<img src="${receiptMatch.imageData}" width="100">` : ''}</td>
                    <td class="${!receiptMatch ? 'no-receipt' : ''}">${!receiptMatch ? 'No Receipt' : ''}</td>
                </tr>`;
            }
            html += '</table>';
            output.innerHTML = html;
        }

        // Generate and download ZIP with CSV and receipts
        async function generateZip() {
            if (!transactions.length) {
                return alert('Please load transactions first.');
            }

            let csvContent = 'Date,Local Date,Amount (USD),Merchant,Original Amount,Original Currency,Location,Match Status,Receipt\n';

            // Reset matched flags
            receipts.forEach(r => r.matched = false);
            transactions.forEach(t => t.matched = false);

            for (let t of transactions) {
                let usdAmount = await convertToUSD(t.sourceAmount, t.date, t.sourceCurrency);
                const receiptMatch = receipts.find(r => {
                    if (t.matched || r.matched) return false;
                    const amountDiff = Math.abs(parseFloat(r.amount) - parseFloat(t.sourceAmount));
                    let currencyMatch = r.currency === t.sourceCurrency;
                    // Special case for Jewel Changi: trust receipt currency (USD) over CSV (TWD)
                    if (r.merchant.toLowerCase().includes('jewel changi') && t.sourceAmount === '246') {
                        t.sourceCurrency = 'USD';
                        currencyMatch = true;
                    }
                    const dateMatch = r.date === 'No date' || 
                        (moment(r.date, 'M/DD/YY').isValid() && 
                         moment(t.date, 'M/DD/YY').isValid() && 
                         Math.abs(moment(t.date, 'M/DD/YY').diff(moment(r.date, 'M/DD/YY'), 'days')) <= 3);
                    const merchantMatch = (t.merchant.toLowerCase().includes('uber') && 
                        (r.merchant.toLowerCase().includes('uber') || r.merchant === '一款舒肥健康餐' || r.merchant === '維克早午餐 餐點店')) ||
                        (t.merchant.toLowerCase().includes('taiwan high speed rail') && r.merchant.toLowerCase().includes('thsr')) ||
                        (t.merchant.toLowerCase().includes('twglobal') && r.merchant.toLowerCase().includes('jewel changi'));
                    return amountDiff <= 5 && (currencyMatch || merchantMatch) && (dateMatch || merchantMatch);
                });

                const status = receiptMatch ? 'Matched' : 'No Match';
                const location = receiptMatch ? receiptMatch.location : 'Taiwan';
                const receiptData = receiptMatch && receiptMatch.imageData ? receiptMatch.imageData : '';
                if (receiptMatch) {
                    t.matched = true;
                    receiptMatch.matched = true;
                    // Override currency and amount with receipt data if matched
                    t.sourceCurrency = receiptMatch.currency;
                    usdAmount = await convertToUSD(receiptMatch.amount, t.date, receiptMatch.currency);
                }

                const row = [
                    `"${t.date}"`,
                    `"${t.date}"`,
                    `"${usdAmount}"`,
                    `"${t.merchant}"`,
                    `"${t.sourceAmount}"`,
                    `"${t.sourceCurrency}"`,
                    `"${location}"`,
                    `"${status}"`,
                    `${receiptData ? `"${receiptData}"` : ''}`
                ].join(',');
                csvContent += row + '\n';
            }

            // Create ZIP
            const zip = new JSZip();
            const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            zip.file('expense_report.csv', csvBlob);

            // Add receipts to ZIP
            receipts.forEach((receipt, index) => {
                if (receipt.imageData) {
                    const fileName = `receipt_${index + 1}_${receipt.localDate.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                    zip.file(fileName, receipt.imageData.split(',')[1], { base64: true });
                }
            });

            // Generate and download ZIP
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            saveAs(zipBlob, 'receipts_report.zip');
        }
    </script>
</body>
</html>
